# claudify — Desktop Notifications for Claude Code Hooks

## Context

Turns a hardcoded `osascript` command in `~/.claude/settings.json` into a general-purpose,
cross-platform npm CLI package that anyone can install and customize — with configurable
text, sounds, icons, and per-event settings.

**Differentiators over prior art (code-notify, claude-notify Python):**
- Zero runtime dependencies — calls native OS commands directly
- JSON Schema config with editor autocompletion
- `install` subcommand for one-command setup
- Template variable system (`{{variable}}`) backed by real hook payload fields

---

## Package

| Field         | Value                         |
|---------------|-------------------------------|
| Package name  | `claudify`                    |
| Repo shape    | Flat (source at root)         |
| Module system | ESM (`"type": "module"`)      |
| Build         | Plain `tsc` → `dist/`         |
| Private       | `false` — intended for npm publish |
| Node.js       | `>=18.0.0`                    |

---

## File Structure

```
claudify/
├── package.json
├── tsconfig.json
├── schema.json                  # Published JSON Schema for config autocompletion
├── docs.md                      # This file
└── src/
    ├── cli.ts                   # Entry point: shebang, subcommand routing
    ├── config.ts                # Config loading + merging
    ├── template.ts              # {{variable}} replacement engine
    ├── notify.ts                # Platform dispatch → sends notification
    ├── read-hook-input.ts       # Synchronous stdin reader (reads hook JSON payload)
    ├── types.ts                 # Shared TypeScript types
    ├── sounds.ts                # Platform sound registry + list command logic
    └── platforms/
        ├── detect.ts            # process.platform → "macos" | "linux" | "windows"
        ├── macos.ts             # osascript -e '...'
        ├── linux.ts             # notify-send
        └── windows.ts          # PowerShell toast (EXPERIMENTAL)
```

**Removed from original plan:**
- `src/flags.ts` — flag parsing is simple enough to inline into `cli.ts`
- `src/sounds/registry.ts` — merged into single `src/sounds.ts`

---

## Key Design Decisions

- **Zero runtime dependencies** — calls native OS commands via `execFileSync` in array form
  (no shell interpolation). This is a security requirement, not just a size preference.
- **`execFileSync` array form only** — never construct shell strings with user data. See
  Security section.
- **`async: true` on all installed hooks** — notifications never block Claude Code.
- **ESM** — matches expected modern Node.js conventions.
- **Plain `tsc` build** — no bundler needed for a zero-dep CLI.
- **Windows support is EXPERIMENTAL** — PowerShell toast without third-party modules
  (`BurntToast`) requires a multi-line inline script. Works on Windows 10+; silently
  skips with a logged warning if PowerShell is unavailable.

---

## Config System

### File search order (first found wins)

1. `$CLAUDIFY_CONFIG` env var (must point to an existing file — errors loudly if missing)
2. `~/.config/claudify/config.json`
3. `~/.claudify.json`

If no config file is found, built-in defaults are used silently.

### Resolution precedence (highest → lowest)

```
CLI flags  →  per-event config  →  file defaults  →  built-in defaults
```

Implemented as a shallow merge — later layers only override keys they define:

```ts
const resolved = { ...BUILTIN_DEFAULTS, ...fileDefaults, ...eventConfig, ...cliFlags };
```

### Default config (generated by `claudify init`)

```json
{
  "$schema": "https://unpkg.com/claudify/schema.json",
  "defaults": {
    "sound": "Glass"
  },
  "events": {
    "Stop": {
      "title": "Claude Code",
      "message": "Task completed in {{project_name}}",
      "sound": "Glass"
    },
    "TaskCompleted": {
      "title": "Claude Code",
      "message": "{{task_subject}} completed",
      "sound": "Glass"
    },
    "Notification": {
      "title": "{{title}}",
      "message": "{{message}}",
      "sound": "Blow"
    },
    "PostToolUse": {
      "enabled": false
    },
    "PostToolUseFailure": {
      "enabled": false,
      "title": "Claude Code",
      "message": "{{tool_name}} failed",
      "sound": "Basso"
    }
  }
}
```

**`PostToolUse` is explicitly disabled by default.** It fires on every tool use
(Bash, Read, Grep, Write, etc.) — 10–30 times per minute during active sessions.
Enabling it causes notification storms and repeated process spawning.

### Config schema note

The `$schema` URL (`https://unpkg.com/claudify/schema.json`) only resolves after the
package is published to npm. `claudify init` logs a notice if the package version used
locally has not yet been published.

---

## Template Variables

Available in `title`, `message`, and `subtitle` fields. Unknown variables render as
empty string (no error). Variables that don't exist in a given hook event (e.g.,
`{{task_subject}}` in a `Stop` event) also render as empty string — this is silent,
so config authors should match variables to the correct event.

| Variable                  | Source                                            | Available in           |
|---------------------------|---------------------------------------------------|------------------------|
| `{{session_id}}`          | `hook_input.session_id`                           | All events             |
| `{{cwd}}`                 | `hook_input.cwd`                                  | All events             |
| `{{project_name}}`        | Basename of `hook_input.cwd`¹                     | All events             |
| `{{hook_event_name}}`     | `hook_input.hook_event_name`                      | All events             |
| `{{title}}`               | `hook_input.title`                                | Notification           |
| `{{message}}`             | `hook_input.message`                              | Notification           |
| `{{notification_type}}`   | `hook_input.notification_type`                    | Notification           |
| `{{task_subject}}`        | `hook_input.task_subject`                         | TaskCompleted          |
| `{{task_id}}`             | `hook_input.task_id`                              | TaskCompleted          |
| `{{last_assistant_message}}` | `hook_input.last_assistant_message`            | Stop                   |
| `{{tool_name}}`           | `hook_input.tool_name`                            | PostToolUse/Failure    |
| `{{error}}`               | `hook_input.error`                                | PostToolUseFailure     |

**¹ `project_name` fallback:** If `cwd` basename is empty, `.`, or a generic name
(`tmp`, root `/`), falls back to the full `cwd` path.

**Explicitly NOT available as template variables:**
- `tool_input` — JSON object that can contain passwords, API keys, or sensitive user
  data. Exposing it in a desktop notification (visible to screen recorders, shoulder
  surfers) is a security risk.
- `transcript_path` — reveals filesystem paths in visible notifications. Available in
  the raw `hook_input` object internally but not exposed to templates.

---

## CLI Usage

```sh
# Default: reads stdin from Claude Code hook → sends notification
echo '{"hook_event_name":"Stop","cwd":"/my/project","session_id":"abc"}' | claudify

# Inline overrides
claudify --title "Done!" --sound Hero

# Subcommands
claudify init                             # Create config file interactively
claudify test                             # Send a test notification
claudify test --sound Pop                 # Test a specific sound
claudify install                          # Add hooks to ~/.claude/settings.json
claudify install --events Stop,Notification,TaskCompleted
claudify install --scope project          # Write to .claude/settings.json
claudify install --scope local            # Write to .claude/settings.local.json
claudify sounds                           # List available system sounds
```

### Supported flags (inline overrides)

| Flag          | Description                              |
|---------------|------------------------------------------|
| `--title`     | Override notification title              |
| `--message`   | Override notification message            |
| `--sound`     | Override sound name                      |
| `--subtitle`  | Override subtitle (macOS only)           |
| `--no-sound`  | Suppress sound                           |

Flags are parsed manually (no third-party parser). Parsing is inlined in `cli.ts`.

---

## `install` Subcommand

Reads the target `settings.json`, merges hooks without overwriting existing user hooks,
then writes back.

### Output format

```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          { "type": "command", "command": "claudify", "async": true }
        ]
      }
    ],
    "TaskCompleted": [
      {
        "hooks": [
          { "type": "command", "command": "claudify", "async": true }
        ]
      }
    ]
  }
}
```

### Flags

| Flag                    | Description                                                    |
|-------------------------|----------------------------------------------------------------|
| `--scope user`          | `~/.claude/settings.json` (default)                           |
| `--scope project`       | `.claude/settings.json` (committed, shared)                   |
| `--scope local`         | `.claude/settings.local.json` (gitignored, personal override) |
| `--events <csv>`        | Comma-separated event names (default: `Stop,TaskCompleted`)   |
| `--force`               | Overwrite existing `claudify` hooks for the specified events  |

### Idempotency

"Already installed" is defined as: the event's hooks array already contains an entry
with `"command": "claudify"`. Without `--force`, duplicates are skipped and a warning
is printed to stderr. With `--force`, the existing entry is replaced.

### Error handling

- If `settings.json` contains invalid JSON: error to stderr, exit 1, no write.
- If write fails (permissions): error to stderr, exit 1.
- If `--events` contains an unrecognised event name: warning to stderr, skipped.
- If `--events` has a trailing comma or empty segment: empty strings are ignored.

---

## Platform Layer

### Dispatch

`notify.ts` uses a dispatch object — adding a new platform doesn't require touching
`notify.ts`:

```ts
const notifiers: Record<Platform, Notifier> = {
  macos: sendMacOS,
  linux: sendLinux,
  windows: sendWindows,
};
notifiers[detectPlatform()](options);
```

If the platform is unsupported or detection fails, `claudify` logs a warning to stderr
and exits 0 (notification is skipped, not a fatal error — hooks should not block Claude
Code).

### macOS

```
osascript -e 'display notification "..." with title "..." sound name "..."'
```

Uses `execFileSync` in **array form** (no shell). AppleScript string values are escaped
using `JSON.stringify` which produces valid double-quoted AppleScript string literals.

### Linux

```
notify-send --app-name="Claude Code" "title" "message"
```

If `notify-send` is not installed, logs a warning to stderr and exits 0.

### Windows (EXPERIMENTAL)

Inline PowerShell script using `[Windows.UI.Notifications.ToastNotificationManager]`.
No third-party module required, but requires Windows 10+ and PowerShell execution
policy that allows script blocks. Silently skips with a warning if unavailable.

---

## Security

### Shell injection

Claude Code invokes hook commands via a shell (`sh -c`). However, `claudify` is the
command being invoked — it receives clean `argv`. The injection risk is **inside**
`claudify` when it constructs OS notification commands.

**Rule:** All `execFileSync` calls use array argument form. No user-controlled data is
interpolated into shell strings.

```ts
// UNSAFE — never do this
execFileSync('sh', ['-c', `osascript -e 'display notification "${message}"'`]);

// SAFE — always do this
const script = `display notification ${JSON.stringify(message)} with title ${JSON.stringify(title)}`;
execFileSync('osascript', ['-e', script]);
```

`JSON.stringify` produces valid AppleScript string literals (double-quoted,
backslash-escaped). This is the correct and sufficient escaping method for osascript `-e`.

### Data exposure

- `tool_input` is not exposed as a template variable (may contain secrets).
- `transcript_path` is not exposed as a template variable (reveals filesystem paths).
- Notifications appear on screen — users should avoid templating sensitive fields into
  `title` or `message` in shared/workplace environments.

---

## Known Failure Modes

| Failure | Symptom | Cause |
|---------|---------|-------|
| macOS notification permission denied | Silent during hooks — `claudify test` prints recovery instructions | osascript exits 0 even when blocked. Only detectable interactively, not from async hooks. |
| notify-send not installed | Silent | Not present on minimal Linux installs. |
| async hook suppresses stderr | All errors invisible | Claude Code does not capture stderr from async hooks. |
| Wrong variables for event | Blank notification field | e.g. `{{task_subject}}` in Stop config → empty string. No error. |
| Config file missing silently | Built-in defaults used | If no config file found, falls back without notice. |
| `$CLAUDIFY_CONFIG` path missing | Error to stderr, exit 1 | Explicit path must exist — unlike search-order fallback. |

**Most important note for users:** Since hooks run with `async: true`, all errors are
silent from Claude Code's perspective. Always run `claudify test` after setup to verify
that notifications are working.

### `claudify test` permission recovery

`osascript` exits 0 even when macOS notification permission is denied — there is no
programmatic way to detect the failure from inside the hook. However, `claudify test`
runs synchronously (not as a hook), so it can print directly to the terminal.

After sending the test notification, `claudify test` always prints:

```
[claudify] Test notification sent.
           If nothing appeared, check:
           System Settings → Notifications → <terminal app> → Allow Notifications: On
```

This message is always shown — not conditionally — because there is no reliable way to
confirm whether the notification was displayed. The user reads it and self-diagnoses.

This is the only place permission issues are surfaced. When running as an async hook,
permission failures are invisible and unrecoverable without re-running `claudify test`.

---

## `stdin` Handling

Claude Code writes the JSON payload to the hook process's stdin and closes it (confirmed
by the `INPUT=$(cat)` pattern in official docs — `cat` reads until EOF).

`read-hook-input.ts` reads synchronously until EOF. If stdin is never closed (i.e.,
`claudify` is run interactively without a pipe), reading blocks. A 5-second timeout is
applied: if stdin does not close within 5 seconds of process start, `claudify` treats
stdin as empty and uses CLI flags / config only.

---

## Implementation Order

1. **Scaffold** — `package.json` (with `engines`, `bin`, `exports`), `tsconfig.json`
2. **Types** — `src/types.ts`: `HookInput`, `NotifyOptions`, `Config`, `Platform`
3. **Template engine** — `src/template.ts`: `{{variable}}` substitution, unknown vars → `""`
4. **Platform layer** — `platforms/detect.ts`, `macos.ts`, `linux.ts`, `windows.ts`, `notify.ts`
5. **Config** — `src/config.ts`, `schema.json`: load + merge with precedence
6. **stdin reader** — `src/read-hook-input.ts`: sync read with 5s timeout
7. **CLI glue** — `src/cli.ts`: shebang, flag parsing, subcommand routing, main notification path
8. **Subcommands** — `init`, `test`, `sounds` (inside `cli.ts` or small inline functions)
9. **Install command** — most complex: JSON merge logic, idempotency, scope handling
10. **postbuild script** — `chmod +x dist/cli.js`, preserve shebang

---

## Local Development Workflow

No npm publish required to test locally. Use `npm link` to make `claudify` available
as a global command that resolves to your local build.

```sh
# 1. Build
bun run build

# 2. Link globally — creates a symlink: claudify → dist/cli.js
npm link

# 3. Verify the command resolves
which claudify        # should point to your local dist/cli.js
claudify test         # sends a real notification

# 4. Install hooks pointing to your local build
claudify install

# 5. Rebuild after code changes — the symlink updates automatically, no re-link needed
bun run build
```

When Claude Code fires the hook it calls `claudify`, which resolves through the symlink
to your local `dist/cli.js`. Any rebuild is picked up immediately.

**To unlink when done:**
```sh
npm unlink -g claudify
```

**Publishing to npm** is only needed when you want others to install it with
`npm install -g claudify`. Local use and testing are fully covered by `npm link`.

---

## Verification Steps

```sh
# 1. Build
bun run build

# 2. Basic notification via stdin
echo '{"hook_event_name":"Stop","cwd":"/Users/me/claudify","session_id":"abc"}' \
  | node dist/cli.js

# 3. Test subcommand
node dist/cli.js test

# 4. Test specific sound
node dist/cli.js test --sound Pop

# 5. List sounds
node dist/cli.js sounds

# 6. Init config
node dist/cli.js init

# 7. Install hooks (dry run first — inspect output)
node dist/cli.js install --scope user

# 8. Verify hooks written correctly
cat ~/.claude/settings.json | grep -A5 '"Stop"'
```

---

## Open Questions

| Question | Status |
|----------|--------|
| Is `claudify` available on npm? | **Unverified** — check before publish |
| Windows PowerShell toast exact script | Defer to implementation — mark EXPERIMENTAL |
| `--scope local` when outside a project dir | Define behavior: error or warn? |
| Should `init` be interactive (prompt per event) or just write defaults? | Decide during implementation |
